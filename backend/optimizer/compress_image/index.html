<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Compression - Ninja PDF</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .options-group {
            margin: 20px 0;
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .option-card {
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 150px;
            text-align: center;
        }

        .option-card:hover {
            border-color: #667eea;
            background: #f7fafc;
        }

        .option-card.selected {
            border-color: #667eea;
            background: #eef2ff;
            color: #5a67d8;
        }

        .option-card h4 {
            margin: 10px 0 5px;
            font-size: 1rem;
        }

        .option-card p {
            font-size: 0.8rem;
            color: #718096;
            margin: 0;
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="container">
            <a href="/" class="logo">
                <i class="fas fa-file-pdf"></i> Ninja PDF <span class="badge">Backend</span>
            </a>
        </div>
    </nav>

    <main class="container">
        <div class="hero">
            <h1>Image Compression</h1>
            <p>Optimize JPG and PNG images for web and storage.</p>
        </div>

        <div class="tool-interface">
            <div class="upload-area" id="dropZone">
                <i class="fas fa-image"></i>
                <p>Drag & Drop your Image here or</p>
                <button class="btn-select" onclick="document.getElementById('fileInput').click()">Select Image
                    File</button>
                <input type="file" id="fileInput" accept="image/png, image/jpeg, image/jpg" hidden>
            </div>

            <div id="optionsArea" style="display: none;">
                <h3>Select Compression Level</h3>
                <div class="options-group">
                    <div class="option-card" onclick="selectOption('less')">
                        <i class="fas fa-image"></i>
                        <h4>Less</h4>
                        <p>High Quality</p>
                    </div>
                    <div class="option-card selected" onclick="selectOption('recommended')">
                        <i class="fas fa-check-circle"></i>
                        <h4>Recommended</h4>
                        <p>Balanced</p>
                    </div>
                    <div class="option-card" onclick="selectOption('extreme')">
                        <i class="fas fa-compress"></i>
                        <h4>Extreme</h4>
                        <p>Smallest Size</p>
                    </div>
                </div>
            </div>

            <div id="fileInfo" class="file-info" style="display: none;">
                <p id="fileName">filename.jpg</p>
                <button class="btn-convert" onclick="processFile()">Compress Image</button>
            </div>

            <div id="loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Compressing...</p>
            </div>

            <div id="resultArea" class="result-area" style="display: none;">
                <p>Compression Complete!</p>
                <a href="#" id="downloadLink" class="btn-download">Download Optimized Image</a>
                <button class="btn-reset" onclick="location.reload()">Compress Another</button>
            </div>
            <p id="errorMsg" style="color: red; display: none; margin-top: 10px;"></p>
        </div>
    </main>

    <script>
        let selectedFile = null;
        let compressionLevel = 'recommended';

        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        // Drag & Drop handlers
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#667eea';
            dropZone.style.background = '#eef2ff';
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#cbd5e0';
            dropZone.style.background = 'white';
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#cbd5e0';
            dropZone.style.background = 'white';
            if (e.dataTransfer.files.length) {
                handleFile(e.dataTransfer.files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            if (!file.type.match('image.*')) {
                alert('Please upload an Image file.');
                return;
            }
            selectedFile = file;
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileInfo').style.display = 'block';
            document.getElementById('optionsArea').style.display = 'block';
            dropZone.style.display = 'none';
        }

        function selectOption(level) {
            compressionLevel = level;
            document.querySelectorAll('.option-card').forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
        }

        async function processFile() {
            if (!selectedFile) return;

            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('optionsArea').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            document.getElementById('errorMsg').style.display = 'none';

            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('level', compressionLevel);

            try {
                const response = await fetch('/optimizer/compress-image/', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const downloadLink = document.getElementById('downloadLink');
                    downloadLink.href = url;

                    let filename = 'compressed_' + selectedFile.name;
                    const disposition = response.headers.get('Content-Disposition');
                    if (disposition && disposition.indexOf('attachment') !== -1) {
                        const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                        const matches = filenameRegex.exec(disposition);
                        if (matches != null && matches[1]) {
                            filename = matches[1].replace(/['"]/g, '');
                        }
                    }
                    downloadLink.download = filename;

                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('resultArea').style.display = 'block';
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Compression failed');
                }
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('fileInfo').style.display = 'block';
                document.getElementById('optionsArea').style.display = 'block';
                const errorMsg = document.getElementById('errorMsg');
                errorMsg.textContent = error.message;
                errorMsg.style.display = 'block';
            }
        }
    </script>
</body>

</html>