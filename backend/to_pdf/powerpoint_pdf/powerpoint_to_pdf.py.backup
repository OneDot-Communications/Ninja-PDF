import os
import subprocess
import platform

# LibreOffice executable paths
LIBREOFFICE_PATHS = [
    r"C:\Program Files\LibreOffice\program\soffice.exe",
    r"C:\Program Files (x86)\LibreOffice\program\soffice.exe",
    "/usr/bin/soffice",
    "/usr/bin/libreoffice",
    "/Applications/LibreOffice.app/Contents/MacOS/soffice"
]

def find_libreoffice():
    """Find LibreOffice executable on the system."""
    for path in LIBREOFFICE_PATHS:
        if os.path.exists(path):
            return path
    return None

def convert_powerpoint_to_pdf(input_path, output_path):
    """Convert PowerPoint (.pptx) to PDF using LibreOffice for exact rendering."""
    
    if not os.path.exists(input_path):
        raise FileNotFoundError(f"File not found: {input_path}")
    
    ext = os.path.splitext(input_path)[1].lower()
    if ext != '.pptx':
        raise ValueError(f"Only .pptx files are supported. Got: {ext}")
    
    # Find LibreOffice
    soffice_path = find_libreoffice()
    if not soffice_path:
        raise RuntimeError("LibreOffice is not installed. Please install LibreOffice to convert PowerPoint files with exact formatting.")
    
    # Create output directory if needed
    output_dir = os.path.dirname(output_path)
    if output_dir and not os.path.exists(output_dir):
        os.makedirs(output_dir)
    
    # Create PDF document with landscape orientation (like PowerPoint slides)
    doc = SimpleDocTemplate(output_path, pagesize=landscape(letter))
    story = []
    
    # Get basic styles
    styles = getSampleStyleSheet()
    title_style = styles['Heading1']
    normal_style = styles['Normal']
    
    # Read .pptx presentation
    prs = Presentation(input_path)
    
    # Create custom styles for better formatting
    centered_style = ParagraphStyle(
        'Centered',
        parent=styles['Normal'],
        alignment=TA_CENTER,
        fontSize=14,
        spaceAfter=12,
        textColor=colors.HexColor('#2c5aa0')
    )
    
    subtitle_style = ParagraphStyle(
        'Subtitle',
        parent=styles['Normal'],
        alignment=TA_CENTER,
        fontSize=12,
        textColor=colors.HexColor('#555555')
    )
    
    # Extract content from slides
    for i, slide in enumerate(prs.slides, 1):
        # Add slide number
        story.append(Paragraph(f"<b>Slide {i}</b>", title_style))
        story.append(Spacer(1, 0.3*inch))
        
        # Extract text from shapes with better formatting
        slide_has_content = False
        for shape in slide.shapes:
                if hasattr(shape, "text") and shape.text.strip():
                    text = shape.text.strip()
                    slide_has_content = True
                    
                    # Replace special characters
                    text = text.replace('&', '&amp;').replace('<', '&lt;').replace('>', '&gt;')
                    
                    # Determine if this is a title shape (usually larger and at top)
                    is_title = hasattr(shape, 'top') and shape.top < Inches(2)
                    
                    # Add paragraphs with appropriate styling
                    lines = text.split('\n')
                    for idx, line in enumerate(lines):
                        if line.strip():
                            if is_title and idx == 0:
                                story.append(Paragraph(f"<b>{line.strip()}</b>", centered_style))
                            elif is_title:
                                story.append(Paragraph(line.strip(), subtitle_style))
                            else:
                                # Regular content - check for bullet points
                                if line.strip().startswith(('â€¢', '-', '*')):
                                    story.append(Paragraph(f"&nbsp;&nbsp;&nbsp;{line.strip()}", normal_style))
                                else:
                                    story.append(Paragraph(line.strip(), normal_style))
                    
                    story.append(Spacer(1, 0.15*inch))
                
                # Try to extract images
                if shape.shape_type == 13:  # Picture type
                    try:
                        image = shape.image
                        image_bytes = image.blob
                        
                        # Convert to PIL Image
                        pil_image = PILImage.open(io.BytesIO(image_bytes))
                        
                        # Save to temp file
                        with tempfile.NamedTemporaryFile(delete=False, suffix='.png') as tmp_file:
                            temp_img_path = tmp_file.name
                            pil_image.save(temp_img_path, 'PNG')
                        
                        # Add to PDF with size constraints
                        img = RLImage(temp_img_path, width=4*inch, height=3*inch, kind='proportional')
                        story.append(img)
                        story.append(Spacer(1, 0.2*inch))
                        slide_has_content = True
                        
                        # Clean up temp file
                        try:
                            os.unlink(temp_img_path)
                        except:
                            pass
                    except Exception as e:
                        print(f"Could not extract image from slide {i}: {e}")
        
        # If slide has no content, add a note
        if not slide_has_content:
            story.append(Paragraph("<i>[Slide contains graphics or content that could not be extracted]</i>", normal_style))
        
        # Add page break between slides (except last one)
        if i < len(prs.slides):
            story.append(PageBreak())
    
    # Build PDF
    doc.build(story)
    
    return output_path
